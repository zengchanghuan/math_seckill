# 三层架构设计说明

## 架构概览

系统采用**题目层 → 实例层 → 展示层**的三层架构，彻底解决"题目反复生成"的问题。

```
┌─────────────────────────────────────────────────┐
│  第1层：题目层 (Question Bank)                  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  - 每道题有唯一questionId                       │
│  - 存储：后端data/questions.json               │
│  - 永远不重新生成，只增删改                    │
│  - 使用SymPy生成题目内容                        │
└─────────────────────────────────────────────────┘
                      ↓ 选题
┌─────────────────────────────────────────────────┐
│  第2层：用户实例层 (User Paper Instance)        │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  - userPaperId: 用户本次训练的ID                │
│  - questionIds: [trig_L1_c_001, ...]            │
│  - sections: {选择填空: [], 解答题: []}         │
│  - 生成一次，永久复用                           │
│  - 存储：后端data/instances.json + 前端本地     │
└─────────────────────────────────────────────────┘
                      ↓ 展示
┌─────────────────────────────────────────────────┐
│  第3层：展示层 (UI Display)                     │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│  - 刷题Tab: 本地固定题库（436道，离线可用）    │
│  - 解答Tab: 后端实例+题库（无限练习，在线）    │
└─────────────────────────────────────────────────┘
```

---

## 两个Tab的差异化定位

### 刷题Tab（DrillPage）
- **数据来源**：本地固定题库 `assets/data/problems.json`
- **特点**：
  - ✅ 离线可用
  - ✅ 题目固定，436道
  - ✅ 支持按主题/难度筛选
  - ✅ 进度可追踪
  - ❌ 题目有限，做完就没了

### 解答Tab（AnswerPage）
- **数据来源**：后端题库 + 用户实例
- **特点**：
  - ✅ 在线生成，题目无限
  - ✅ 不会重复（实例化后固定）
  - ✅ 支持章节/节选择
  - ✅ 可以"开始新一轮训练"
  - ❌ 需要网络连接

---

## 核心工作流程

### 解答Tab工作流程

```
用户进入解答Tab
      ↓
检查本地是否有该配置的实例ID
      ↓
┌─────┴─────┐
│有         │无
↓           ↓
从后端      创建新实例
加载实例    (POST /api/instance/create)
(GET /api/  ↓
instance/   后端从题库选题
{id})       (优先选未用过的)
↓           ↓
获得题目    保存实例到后端
列表        保存instanceId到本地
      ↓
展示题目（上一题/下一题）
      ↓
用户可选择"开始新一轮训练"
      ↓
清除本地实例ID，重新创建
```

### 题目生成流程（后端）

```
接收创建实例请求
      ↓
根据主题/难度/章节查询题库
      ↓
┌─────┴─────┐
│够         │不够
↓           ↓
随机选择    生成新题
现有题目    ↓
            使用SymPy生成
            ↓
            分配唯一questionId
            ↓
            保存到题库
      ↓
组装成实例（分section）
      ↓
返回实例+题目列表
```

---

## 数据结构

### 题目层（Question）

```json
{
  "questionId": "trig_L1_c_001",
  "topic": "三角函数",
  "difficulty": "L1",
  "type": "choice",
  "chapter": "第1章 三角函数",
  "section": "§1.1 三角函数的概念",
  "question": "函数 $f(x) = \\sin(x)$ 的定义域是？",
  "answer": "A",
  "solution": "...",
  "options": ["所有实数", "x ≠ 0", "x > 0", "..."],
  "tags": ["三角函数", "基础概念"],
  "answerType": null,
  "answerExpr": null,
  "createdAt": "2025-12-02T16:45:00"
}
```

### 实例层（UserPaperInstance）

```json
{
  "instanceId": "guest_20251202_164530",
  "userId": null,
  "topic": "三角函数",
  "difficulty": "L1",
  "chapter": "第1章 三角函数",
  "section": "§1.1 三角函数的概念",
  "sections": [
    {
      "sectionName": "选择填空题",
      "questionIds": ["trig_L1_c_001", "trig_L1_f_002", ...]
    },
    {
      "sectionName": "解答题",
      "questionIds": ["trig_L1_s_001", ...]
    }
  ],
  "totalQuestions": 20,
  "createdAt": "2025-12-02T16:45:30",
  "userAnswers": {},
  "answerStatus": {}
}
```

---

## 避免题目重复的机制

### 1. 题目唯一性
- 每道题生成后分配唯一ID（格式：`{topic}_{difficulty}_{type}_{序号}`）
- 保存到题库，永远不重新生成

### 2. 实例固定性
- 用户进入某个训练配置（如"三角函数-第1章-§1.1"）时：
  - 第一次：创建实例，选20道题
  - 后续：复用同一实例，题目列表不变
- 本地存储instanceId，下次直接加载

### 3. 新一轮训练
- 用户可主动点击"开始新一轮训练"
- 清除本地实例ID
- 重新创建实例（从题库选择不同的题目）

### 4. 题库扩展
- 题库不足时，后端自动生成新题并加入题库
- 已有题目优先复用，避免重复生成

---

## 本地存储策略（SharedPreferences）

### 存储的key

```dart
// 训练实例ID
'training_instance_{topic}_{chapter}_{section}'
// 示例：
'training_instance_三角函数_第1章 三角函数_§1.1 三角函数的概念'

// 值：instanceId（如 "guest_20251202_164530"）
```

### 数据流

1. 进入解答Tab → 读取对应key的instanceId
2. 有instanceId → 调用后端加载实例
3. 无instanceId → 调用后端创建新实例 → 保存instanceId
4. 切换章节/节 → 使用新的key，可能触发新实例创建

---

## API接口说明

### 创建训练实例

```http
POST /api/instance/create
Content-Type: application/json

{
  "userId": "user123",  // 可选
  "topic": "三角函数",
  "difficulty": "L1",
  "chapter": "第1章 三角函数",
  "section": "§1.1 三角函数的概念",
  "questionCount": 20
}

Response:
{
  "instance": {
    "instanceId": "user123_20251202_164530",
    "sections": [...],
    ...
  },
  "questions": [...]  // 所有题目的完整内容
}
```

### 获取训练实例

```http
GET /api/instance/{instanceId}

Response:
{
  "instance": {...},
  "questions": [...]
}
```

---

## 未来扩展方向

### 1. 用户做题记录
- 记录每道题的做题次数、正确率
- 新实例创建时优先选"未做过"或"错误率高"的题

### 2. 智能选题
- 根据用户历史表现，调整难度
- 推荐薄弱知识点的题目

### 3. 数据库支持
- 将JSON文件替换为PostgreSQL/MongoDB
- 支持多用户并发

### 4. 小程序迁移
- 后端逻辑不变
- 前端从Flutter改为微信小程序
- 用户实例存储在云数据库

---

## 总结

通过三层架构设计，系统实现了：

1. ✅ **题目不重复生成**：题库稳定，题目唯一
2. ✅ **训练可暂停继续**：实例持久化，随时恢复
3. ✅ **两Tab差异化**：刷题离线固定，解答在线无限
4. ✅ **可扩展性强**：未来可加数据库、用户系统、小程序

核心原则：**生成一次，永久复用。**

